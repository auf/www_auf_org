{% load sekizai_tags staticfiles auf %}

{% addtoblock "css" %}
    <link rel="stylesheet" href="{{ STATIC_URL }}css/ol.css" type="text/css"/>
    <link rel="stylesheet" href="{{ STATIC_URL }}css/carte.css" type="text/css"/>
    <style>
      .ol-popup {
        position: absolute;
        background-color: white;
        -webkit-filter: drop-shadow(0 1px 4px rgba(0, 0, 0, 0.2));
        filter: drop-shadow(0 1px 4px rgba(0, 0, 0, 0.2));
        padding: 15px;
        border-radius: 10px;
        border: 1px solid #cccccc;
        bottom: 35px;
        left: -50px;
      }

      .ol-popup:after, .ol-popup:before {
        top: 100%;
        border: solid transparent;
        content: " ";
        height: 0;
        width: 0;
        position: absolute;
        pointer-events: none;
      }

      .ol-popup:after {
        border-top-color: white;
        border-width: 10px;
        left: 48px;
        margin-left: -10px;
      }

      .ol-popup:before {
        border-top-color: #cccccc;
        border-width: 11px;
        left: 48px;
        margin-left: -11px;
      }
    </style>
{% endaddtoblock %}

{% addtoblock "js" %}
    <script src="{{ STATIC_URL }}js/ol.js"></script>
    <script src="{{ STATIC_URL }}js/carte.js"></script>
  <script type="text/javascript">
    const COULEURS_BUREAUX = {'BSC': '#FF0000', 'BACGL': '#F7AB00', 'BA': '#34AB92',
                    'BAP': '#9F72AE', 'BC': '#601D52', 'BM': '#B49B5A',
                    'BMO': '#387DC0', 'BOI': '#EE79AD', 'BECO': '#73D0F5',
                    'BAO': '#65B22E', 'BEOM': '#000088', 'BEO': '#EA560D'};

    
    var carte;
    var div_carte = $("#carte");
    var implantation_marker_url = div_carte.data('implantation-marker-url');
    var membre_marker_url = div_carte.data('membre-marker-url');

    function make_mini_popup_element(code_pays, nom, implantations, nb_etablissements,
                                     nb_par_type) {
      var noms_implantations =  [];
      $.each(implantations, function(i, impl) {
        noms_implantations.push(impl.nom) });
      var html = '';
      if (nb_etablissements) {
    html += '<span class="etablissements"></span>';
      }

      $.each(nb_par_type, function(code_type, nb) {
       if (nb){
         html += '<span class="' + code_type + '"></span>';
      };
      });

      var new_popup = $('<div class="ol-popup"></div>');
      new_popup.html(html);
      $('#popups').append(new_popup);
      return new_popup;
    }

    function make_popup_element(code_pays, nom, implantations, nb_etablissements,
                               nb_par_type) {
      var noms_implantations =  [];
      $.each(implantations, function(i, impl) {
        noms_implantations.push(impl.nom) });
      var html = '<p class="ol-popup-titre">' + nom + '</p>'
               + '<p class="implantation">' + noms_implantations.join('<br/>') + '</p>'
               + '<ul class="ol-popup-liste">'
               + '<li class="etablissements">'
               + '<strong>' + nb_etablissements.toString() + '</strong> Établissements</li>';
      $.each(nb_par_type, function(code_type, nb) {
      if(nb) {
    html += '<li class="' + code_type + '">' + code_type + ':' + nb.toString() + '</li>';
      };
      });
      html += '</ul>';

      var new_popup = $('<div class="ol-popup"></div>');
      new_popup.html(html);
      $('#popups').append(new_popup);
      return new_popup;
    }

    function init_carte(donnees_carte) {
      carte = Carte.init({
        container_id: 'carte',
        donnees_carte: donnees_carte,
        implantation_marker_url: implantation_marker_url,
        membre_marker_url: membre_marker_url,
        make_popup_element: make_mini_popup_element,
        popup_threshold: 5000,
        couleurs_bureaux: COULEURS_BUREAUX,
        filtre_region: 'BA',
        zoom_to_region: 'BA'
      });
    }

    function filtre_change() {
      var code_bureau = $('#filter-bureau').val();
      var type = $('#filter-type').val();
      carte.filter_map(code_bureau, type);
      carte.zoom_to_region(code_bureau);
    }

    $(function() {
      $.getJSON('/auf_carte/donnees_carte.json', init_carte);
      $('#filter-bureau').change(filtre_change);
      $('#filter-type').change(filtre_change);
    });
  </script>
{% endaddtoblock %}

  <div class="filters">
    <form>
      <label for="filter-bureau">Filtre bureaux</label>
      <select id="filter-bureau">
        <option value="tous">Tous</option>
        {% for bureau in bureaux %}
          <option value="{{ bureau.code }}">{{ bureau.nom }}</option>
        {% endfor %}

      </select>
    <label for="filter-type">Filtre type</label>
    <select id="filter-type">
      <option value="tous">Tous</option>
      <option value="etablissements">Établissements</option>
      <option value="implantations">Implantations</option>
    </select>
    </form>
  </div>
  <div id="carte" style="height: 600px; width: 100%"
       data-implantation-marker-url="{{ STATIC_URL }}img/google-309739_640.png"
       data-membre-marker-url="{{ STATIC_URL }}img/google-309740_640.png">

  </div>

    <div id="popup" class="ol-popup">
    </div>
  <div id="popups" style="visibility: hidden;">





